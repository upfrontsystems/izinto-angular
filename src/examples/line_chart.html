<!-- example of d3 line chart displaying query results -->
<html>

<!-- Google Fonts -->
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Poppins:300,300italic,700,700italic">

<style>
</style>

<body>

    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script type='text/javascript' src='../../static/js/time-series-chart.js'></script>

    <div id="chart"></div>

    <script type="module">
        var dateSelection = {};

        var chart = timeSeriesChart()
            .x(function (d) { 
                return d.date; })
            .y(function (d) { return +d.value; });
        var formatDate = d3.timeFormat('%d %b');    

        // load query result
        function loadQuery() {
            if (!dateSelection) {
                return;
            }
            var query = {
                'query':
                {
                    'name': 'table_query',
                    'values': { dev_id: '1406300003', range: dateSelection.dateRange, query_group_by: '1d' }
                }
            };

            // execute query
            window.top.postMessage(query, '*');
        }

        // build d3 table with results
        function buildTable(response) {
            if (!response['results']) {
                return;
            }

            // get single series result nested in database response
            var dataSets = formatResponse(response['results']);

            d3.select("#chart").datum(dataSets).call(chart);
        }

        function formatResponse(results) {
            var seriesList = results[0].series;
            var dataSets = [];
            var groupByValue = 60 * 60 * 24;
            for (var series of seriesList) {
                var datasets = [];
                var tag;
                if (seriesList.length > 1) {
                    var tags = Object.keys(series['tags']).map(function (key) {
                        return series['tags'][key];
                    });
                    tag = tags[0];
                }

                for (var record of series['values']) {
                    var date = new Date(record[0]);
                    if (date < dateSelection.startDate || date > dateSelection.endDate) {
                        continue;
                    }
                    // Add timezone offset if group by is greater than 1 hour
                    if (groupByValue > 3600) {
                        var timeOffsetInMS = date.getTimezoneOffset() * 60000;
                        date.setTime(date.getTime() + timeOffsetInMS);
                    }
                    var values = record.splice(1);
                    // a record can have multiple values which must be unpacked into different data sets
                    values.forEach((val, index) => {
                        if (datasets[index] === undefined) {
                            datasets[index] = [];
                        }
                        var rec = {};
                        rec.date = date;
                        if (tag) {
                            rec.fieldName = series['columns'][index + 1] + ': ' + tag;
                        } else {
                            rec.fieldName = series['columns'][index + 1];
                        }
                        rec.value = val;
                        rec.header = tag || rec.fieldName;
                        if (val !== null) {
                            datasets[index].push(rec);
                        }
                    });
                }

                // if there is only one record in this dataset exclude it
                if (datasets[0] && datasets[0].length === 1 && resp['results'].length > 1) {
                    continue;
                }
                for (var dataset of datasets) {
                    dataset.sort();
                    dataSets.push(dataset);
                }
            }
            return dataSets;
        }

        window.addEventListener("message", receiveMessage, false);

        function receiveMessage(event) {
            // date selection updated load query
            if (event.data.type === 'date_range_updated') {
                dateSelection = event.data.message;
                loadQuery();
                // set dashboard variables
            } else if (event.data.type === 'result') {
                buildTable(event.data.message.result.results);
            }
        }

        // send ready message
        window.top.postMessage({ 'status': 'ready' }, '*');

    </script>
</body>

</html>